## Как пройти... к третьей нормальной форме?

При разработке базы данных самым сложным является разработка такой её структуры (описание таблиц и их полей), чтобы при изменениях можно было только добавлять новые таблицы и записи, не меняя  взаимосвязи между уже имеющимися. Помогает этому в том числе и нормализация таблиц, то есть система определённых правил (чем больше номер формы, тем шире набор правил, которые должны соблюдаться). В литературе описывается шесть или даже больше нормальных форм, однако в большинстве случаев достаточно доведения базы данных до третьей нормальной формы, в ряде случаев допускается отступление и от этих требований (т.е. денормализация таблиц), если это даёт прирост производительности. В общем, нормальная форма - не истина в последней инстанции, а некоторый набор правил, которые почему-то довольно трудно усваиваются студентами - видимо, в силу того, что тех заставляют вызубрить, а не понять. Как известно, то, что понял, забыть невозможно, поэтому здесь я изложу своё понимание механизма не только приведения базы данных к 3nf, но и самого проектирования базы данных, следуя которому, вы получите легко обслуживаемую и расширяемую БД. Здесь не будет выдержек из википедии или учебников, но будет один сквозной пример, на котором мы и разберём весь спектр заявленных вопросов.

## В качестве примера мы рассмотрим базу данных с расписанием занятий учебного заведения (техникума, колледжа, школы)

Прежде всего, разберёмся, с какой информацией мы будем работать. Предположим, что есть некоторое учебное заведение, диспетчер которого, составляя расписание, стыкует преподавателей, аудитории, учебные группы и предметы, по которым ведётся занятие. Руководство учебного заведения обратилось к вам, как к разработчику баз данных, с просьбой посодействовать созданию эффективного приложения, способного легко и просто формировать расписание занятий на любой грядущий день учебного года. На данный момент «база данных», если её так можно назвать, ведётся в таблице Excel и занимает ровно одну вкладку, где содержится таблица со следующими заголовками:

```
Исходная структура базы данных:
* Дата
* Номер пары
* ФИО преподавателя
* № группы
* № кабинета
* Предмет
* Примечания
```
В примечаниях может быть указано, что занятие отменено по причине болезни преподавателя, что по техническим причинам занятие было перенесено в другую аудиторию или на другое время, ну и прочие рабочие моменты.

Можно ли пользоваться такой базой данных, состоящей из одной таблицы? Безусловно! Но есть нюансы. И они проявляются не сразу, а постепенно, в процессе работы.

Таблица 1. Расписание в одной таблице

|Дата|№ пары|ФИО преп|№ группы|№ кабинета|Предмет|Прим|
|----|------|--------|--------|----------|-------|----|
|1.9 |1     |Иванов  |101     |25        |Р.яз.  |    |
|1.9 |2     |Петров  |101     |16        |Матем. |    |
|1.9 |3     |Сидорова|101     |312       |Ин.яз. |    |
|1.9 |1     |Петров  |205     |16        |Матем. |    |
|1.9 |2     |Сидорова|205     |312       |Ин.яз. |    |
|1.9 |3     |Иванов  |205     |25        |Р.яз.  |    |

Обратим внимание на то, что в этой таблице очень много повторений. Дата везде стоит одна и та же (конечно, скоро в этой таблице будет содержаться расписание и на другие учебные дни, так что даты начнут меняться. Номера пар тоже не блещут оригинальностью, и действительно: если предположить, что пара состоит из двух (внезапно) уроков по 45 минут, между которыми есть перерыв 10 минут, между парами также есть перерывы по 10-30-60 минут (не забываем про обед), то в один рабочий день можно уместить с горем пополам 7 пар (примерно с 8 утра и до 21 или даже 22 часов вечера), то есть в этом столбце у нас будут значения от 1 до 7 максимум. Следующий столбец, с фамилиями преподавателей, содержит в расчёте на один день до семи повторений (обычно диспетчер учебного заведения не рискует ставить преподавателю сразу все семь пар в один день, последняя одна-две пары используются для того, чтобы соотнести с конкретными датами часы самостоятельной работы студента по дисциплине. Аналогично смотрим остальные поля и понимаем, что и по ним в таблице будут сплошные повторы.

Попробуем для начала вынести в отдельные таблицы информацию о преподавателях, кабинетах, учебных предметах и номерах пар (в предпраздничные дни сокращённое рабочее время, в связи с чем учебное заведение может пойти на сокращение длительности пары, а может - просто уменьшить число проводимых в этот день пар и у преподавателя, и у группы). Таблица с информацией о преподавателях будет выглядеть так:

Таблица 2. Преподаватели

|prep_id|FIO_prep|
|-------|--------|
|1      |Иванов  |
|2      |Петров  |
|3      |Сидорова|


Таблица с информацией о кабинетах будет такой:

Таблица 3. Кабинеты

|kab_id | номер кабинета |
|-------|----------------|
|1      | 25             |
|2      | 16             |
|3      | 312            |


Аналогично можно собрать в отдельную таблицу информацию по предметам

Таблица 4. Предметы

| predmet_id | Название предмета |
|------------|-------------------|
| 1          | Р.яз.             |
| 2          | Матем             |
| 3          | Ин.яз             |

Обратим внимание, что два поля, указывающие на время, когда состоялось (или планируется) занятие, можно объединить и вынести в отдельную таблицу (таблица 5):

Таблица 5. Дата и время занятия

|Lessons_id | date  | Lessons_number |
|-----------|-------|----------------|
|1          | 1.9   | 1              |
|2          | 1.9   | 2              |
|3          | 1.9   | 3              |

Теперь наша база данных представляет собой несколько таблиц — по преподавателям (таблица 3), по предметам (таблица 4), по датам и времени занятий (таблица 5). В принципе, можно было не объединять дату и номер пары, использовав ID для даты и ID для номера пары (собственно, номер пары сам себе является ID). Перепишем наш фрагмент базы данных, подставив вместо исходных значений номера соответствующих идентификаторов (таблица 6). Примечание можно добавить по такой же схеме - идентификатор плюс новая табличка.

Таблица 6. Фрагмент базы данных (улучшенной) с внесённой в неё информацией

| prep_id | kab_id | predmet_id | Lessons_id |
|---------|--------|------------|------------|
| 1       |1       |1           |1           | 
| 2       |2       |2           |2           |
| 3       |3       |3           |3           |
| 2       |2       |2           |1           |
| 3       |3       |3           |2           |
| 1       |1       |1           |3           |

Мы видим, что в такой таблице отсутствует индекс. Теоретически, в таком качестве можно было бы использовать связку полей LessonID и TeacherID (а, возможно, и остальных), однако во-первых, где гарантия, что в результате ошибки не появятся дубли (т. е. не будет нарушена целостность таблицы)? А во-вторых, если мы в качестве индекса возьмём большое количество полей, в дальнейшем это может препятствовать расширению базы данных (вам будет сложнее добавлять в эту базу новую информацию, поскольку требованием уникальности значений в полях записи, заявленных в индексе, вы наложите на таблицу и её значения серьёзные ограничения, что вызовет сложности в изменении этой таблицы (как минимум, придётся пересчитывать индексы при каждом подобном изменении, что далеко не всегда оправдано). В нашей ситуации есть смысл добавить в таблицу индексное поле — это будет синтетический, или искусственный индекс, представляющий собой поле, содержащее значение счётчика. Конкретно в этой таблице синтетический счётчик ничего не «сломает», почему — расскажу немного позже.

Обратим внимание, что большинство преподавателей занимается строго в своих кабинетах (хотя некоторые преподаватели не имеют «своего» кабинета, поэтому им назначают занятия в разных кабинетах). Можем также вынести эти данные в новую таблицу (таблица 7).

Таблица 7. Закрепление кабинетов за преподавателями
| AudienceID  | Номер_кабинета  | TeacherID  |
|-------------|-----------------|------------|
| 1           | 19              | 002        |
| 2           | 24              | 001        |
| 3           | 26              | 002        |
| 4           | 26              | 003        |

Ну и последний штрих: создадим отдельную таблицу для примечаний, куда будем вносить информацию, не нашедшую места в расписании (выделять для этого целое поле в исходной таблице — верх нерациональности). Хранение значения «1» вместо текстового поля размером в несколько килобайт для каждого занятия не только экономит память, но и поможет в дальнейшем ускорить поиск информации по этому полю.

Таблица 8. Примечания
| NoteID | Текст примечания |
|--------|------------------|
| 1      | <пусто>          |

Тогда наша основная таблица с расписанием приобретёт следующий вид:

Таблица 9. Фрагмент базы данных (вновь улучшенной) с откорректированной информацией

| ID | LessonID | AudienceID| № группы | SubjectID | NoteID |
|----|----------|-----------|----------|-----------|--------|
| 1  | 001      | 2         | 111      | 001       | 1      |
| 2  | 002      | 2         | 111      | 001       | 1      |
| 3  | 003      | 2         | 112      | 002       | 1      |
| 4  | 004      | 2         | 112      | 002       | 1      |
| 5  | 001      | 3         | 114      | 003       | 1      |
| 6  | 002      | 3         | 114      | 003       | 1      |
| 7  | 003      | 1         | 115      | 003       | 1      |
| 8  | 004      | 1         | 115      | 003       | 1      |
| 9  | 003      | 4         | 114      | 004       | 1      |
| 10 | 004      | 4         | 114      | 004       | 1      |
| 11 | 005      | 4         | 115      | 004       | 1      |
| 12 | 006      | 4         | 115      | 004       | 1      |

Аналогичным образом можно поступить и с номером группы. Более того, сейчас мы про группу ничего не знаем — ни какой это курс, ни какая специальность, ни сколько человек учится в этой группе, а это очень важная информация для составления расписания! Если бы мы продолжали работать со старой таблицей (см. табл. 2), добавление этой информации о группе привело бы к раздуванию таблицы минимум на три поля, и эта информация, дублируясь, не только заняла бы лишнее место в памяти сервера и на диске, но и замедлила бы поиск нужных записей. Для того, чтобы закрепить полученные знания, выполните подобную оптимизацию наших таблиц самостоятельно. Как будет выглядеть итоговая таблица, где мы регистрируем все занятия? А какие вспомогательные таблицы будут её дополнять? Как будет выглядеть каждая из них?

Если вы попробуете нарисовать схему хранения информации в этой системе таблиц, вы увидите, что есть одна большая таблица — можно сказать, что она главная, в ней содержится информация о событиях, для регистрации которых и создаётся база данных, и есть множество мелких таблиц, что-то уточняющих и дополняющих, имеющих второстепенное значение по отношению к первой. Я называю эти мелкие таблицы справочниками. Итак, повторю: в одной большой таблице мы регистрируем СОБЫТИЯ, тогда как множество мелких таблиц, дополняющих её, являются СПРАВОЧНИКАМИ (сразу отмечу, что в учебниках по СУБД вы этих двух терминов не встретите - деление на справочники и события это моя идея). Понимание этого очень важно при проектировании базы данных.

Приступая к проектированию базы данных, старайтесь прежде всего обнаружить, что в ней является СОБЫТИЕМ. Могу дать подсказку: событие — это нечто достаточно уникальное, неповторимое, происходящее много-много-много раз. Собственно говоря, СОБЫТИЕ — это то, ради чего и создаётся вся база данных, и в корректно разработанной НЕБОЛЬШОЙ базе данных (вроде нашего примера с расписанием занятий) у вас будет только одно СОБЫТИЕ, не больше и не меньше, поскольку оно является «ядром» всей базы, единственным, неповторимым и неделимым. В некоторых базах данных можно обнаружить два события и даже более, но, разобравшись с этими базами, вы увидите, что у них более одного «ядра» (например, вы пишете базу данных для больницы — а там есть выписка лекарств, и по хорошему это должна быть одна база (аптеки), есть врачи, пациенты, приёмы и назначения лекарств — это другая база (приёмы), есть процедурные кабинеты, процедуры и тому подобное — это ещё одна база, а то и несколько. 

Справочником можно назвать любую другую таблицу базы данных (не являющуюся СОБЫТИЕМ). Нередко студенты путаются, не могут определить, что является справочником — им кажется, что половина таблиц их базы — СОБЫТИЯ. Это неверно. Причиной подобных ошибок является то, что тогда как таблица, описывающая СОБЫТИЕ, растёт при каждом добавлении в базу информацию, некоторые справочники также имеют обыкновение расти вместе с главной таблицей, хотя и делают это несколько медленнее. Предположим, вы проектируете базу данных для республиканской больницы — в качестве СОБЫТИЯ будут выступать случаи приёма специалистом пациента, однако почти так же быстро, как и главная таблица, будет расти справочник по пациентам — в силу того, что большинство из них обратится в больницу один раз в своей жизни (для этого им пришлось ехать в другой город, обращение было неотложным, в экстренных случаях они вообще сюда не доедут, а в менее сложных случаях обратятся за помощью по месту жительства). Не нужно пугаться того, что какой-то справочник растёт быстро, это нормально.

Могу предложить ещё один лайфхак для того, чтобы определить, какие таблицы считать справочниками, а какие - событиями. База данных нужна и важна не сама по себе, а как инструмент, и этот инструмент рассказывает ИСТОРИЮ. Например, история, которую рассказывает расписание занятий, заключается в том, что какие-то преподаватели в заданное время в заданных кабинетах провели у определённых групп занятия по некоторым предметам или дисциплинам. История? Несомненно! Так вот, таблица, глядя на которую мы можем восстановить эту историю, подглядывая в другие для уточнения деталей, и будет таблицей, описывающей события. Событие - это отдельное занятие по отдельно взятой дисциплине, проведенное конкретным преподавателем в конкретном кабинете у конкретной группы. Всё остальное - справочники. 


Преимущества деления всех таблиц на СОБЫТИЯ и СПРАВОЧНИКИ заключается в том, что вы всегда понимаете, где и как можно и нужно расширить таблицу для внесения в неё дополнительной информации.
Возьмём пример с нашей базой данных, описанной таблицами 3-5 и 7-9: девятая таблица описывает СОБЫТИЕ (занятие, проведённое в конкретную дату, на конкретной паре, конкретным преподавателем, в конкретной группе, в конкретной аудитории), а все остальные по отношению к ней являются справочниками. Любой справочник может быть дополнен и расширен, причём это не затронет главную таблицу — в ней по-прежнему останется ссылка на справочник. Покажу это на примере таблицы 7 (закрепление кабинетов за преподавателями). Предположим, что в некоторых кабинетах есть проектор, и  выясняется, что преподавателю с TeacherID=2 очень важно, чтобы в кабинете, где он проводит занятие, проектор имелся. Тогда мы добавим в справочник, содержащий информацию о кабинетах, столбец ProjectorAvailability («Наличие проектора» (да/нет):

Таблица 10. Закрепление кабинетов за преподавателями (дополненная версия)

| AudienceID  | Номер_кабинета | TeacherID  | ProjectorAvailability  |
|-------------|----------------|------------|------------------------|
| 1           | 19             | 002        | No                     |
| 2           | 24             | 001        | No                     |
| 3           | 26             | 002        | Yes                    |
| 4           | 26             | 003        | Yes                    |

Как мы видим, преподавателю с TeacherID = 002 ставили занятия в 19 и 26 кабинетах, однако в первом проектор отсутствует, следовательно, диспетчер в следующий раз составит расписание таким образом, чтобы этот преподаватель вёл занятия именно в 26 кабинете. Ну и в целом, в этом примере мы также видим, что изначально составленная таблица, объединяющая и кабинеты, и преподавателей, «разъезжается» на два разных справочника (во всяком случае, из неё хочется изъять TeacherID как нечто, не имеющее отношения к кабинету). В базах данных не может быть «правильной» и «неправильной» структуры данных — она может быть более и менее эффективная, легко или сложно поддерживаемая (подвергающаяся изменениям).

Насколько сильно должны мы дробить таблицы в ходе оптимизации? Хороший вопрос! С одной стороны, таблицы, приведённые к третьей нормальной форме, выглядят "красиво", такую базу данных легко дополнять новой информацией (независимо от того, добавляется она на уровне событий или справочников, уже существующая структура не "рассыпается" и не требует срочного рефакторинга). С другой стороны, когда база данных размещается в большом количестве отдельных таблиц, она начинает требовать больших объёмов оперативной памяти компьютера (и, соответственно, может отказаться работать на стареньком сервере с маленькой оперативкой). Решить эту проблему можно денормализацией, когда мы объединяем некоторые таблицы. Например, мы можем из двух справочников - предметы и преподаватели - сделать один, объединив в нём информацию о предметах и о том, кто их ведёт. В этой таблице появятся повторы значений (например, если преподаватель ведёт десять разных дисциплин, то его фамилия в таблице встретится десять раз, и если одну дисциплину ведёт несколько преподавателей, то её название также будет продублировано в нескольких строчках). Поскольку денормализация задевает справочники, которые, как правило, имеют небольшой объём и не подвержены активному росту, падение скорости работы если и будет, то окажется незначительным (хотя это интересный вопрос, который следует изучить отдельно и нак конкретных примерах, - как на время выполнения запроса повлияет объединение двух справочников в один?). Кроме того, по новому, денормализованному справочнику мы можем создать индекс, который ускорит выполнение запросов к справочнику.

